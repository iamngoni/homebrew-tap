name: Update Formula

on:
  repository_dispatch:
    types: [update-formula]

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}

      - name: Update formula
        env:
          VERSION: ${{ github.event.client_payload.version }}
        run: |
          VERSION_NUM=${VERSION#v}
          BASE_URL="https://github.com/iamngoni/bitbucket-cli/releases/download/${VERSION}"

          DARWIN_ARM_SHA=$(curl -sL "${BASE_URL}/bb-darwin-aarch64.tar.gz.sha256" | awk '{print $1}')
          DARWIN_X64_SHA=$(curl -sL "${BASE_URL}/bb-darwin-x86_64.tar.gz.sha256" | awk '{print $1}')
          LINUX_ARM_SHA=$(curl -sL "${BASE_URL}/bb-linux-aarch64.tar.gz.sha256" | awk '{print $1}')
          LINUX_X64_SHA=$(curl -sL "${BASE_URL}/bb-linux-x86_64.tar.gz.sha256" | awk '{print $1}')

          mkdir -p Formula

          cat > Formula/bb.rb << EOF
          class Bb < Formula
            desc "Modern CLI for Bitbucket Cloud and Server/Data Center"
            homepage "https://github.com/iamngoni/bitbucket-cli"
            version "${VERSION_NUM}"
            license "MIT"

            on_macos do
              on_arm do
                url "${BASE_URL}/bb-darwin-aarch64.tar.gz"
                sha256 "${DARWIN_ARM_SHA}"
              end
              on_intel do
                url "${BASE_URL}/bb-darwin-x86_64.tar.gz"
                sha256 "${DARWIN_X64_SHA}"
              end
            end

            on_linux do
              on_arm do
                url "${BASE_URL}/bb-linux-aarch64.tar.gz"
                sha256 "${LINUX_ARM_SHA}"
              end
              on_intel do
                url "${BASE_URL}/bb-linux-x86_64.tar.gz"
                sha256 "${LINUX_X64_SHA}"
              end
            end

            def install
              if OS.mac? && Hardware::CPU.arm?
                bin.install "bb-darwin-aarch64" => "bb"
              elsif OS.mac? && Hardware::CPU.intel?
                bin.install "bb-darwin-x86_64" => "bb"
              elsif OS.linux? && Hardware::CPU.arm?
                bin.install "bb-linux-aarch64" => "bb"
              elsif OS.linux? && Hardware::CPU.intel?
                bin.install "bb-linux-x86_64" => "bb"
              end
            end

            test do
              system "#{bin}/bb", "--version"
            end
          end
          EOF

          # Remove leading spaces from heredoc
          sed -i 's/^          //' Formula/bb.rb

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/bb.rb
          git diff --staged --quiet || git commit -m "Update bb to ${{ github.event.client_payload.version }}"
          git push
